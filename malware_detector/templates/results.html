<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scan Results</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <style>
      body {
        background-color: #f8f9fa;
      }
      .container {
        max-width: 1140px;
      } /* Wider container for results */
      .alert {
        margin-top: 1.5rem;
      }
      .table {
        margin-top: 1.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
      }
      .table th {
        white-space: nowrap;
        background-color: #e9ecef;
      }
      .table td {
        word-break: break-all;
        vertical-align: middle;
      }
      .badge {
        font-size: 0.85em;
      }
      .footer {
        padding: 2rem 0;
        margin-top: 3rem;
        font-size: 0.9em;
        text-align: center;
      }
      .form-check-input {
        cursor: pointer;
      }
      code {
        background-color: #e9ecef;
        padding: 0.2em 0.4em;
        border-radius: 3px;
        font-size: 0.85em;
      }
      label.form-check-label {
        cursor: pointer;
      }
    </style>
    <script>
      // Pass Flask data to JavaScript - Ensure this runs before the other script block
      const detectedThreatsData = {{ detected_threats | tojson | safe }};

      // Optional: Create a lookup map using the index for potentially easier access
      const threatLookup = {};
      detectedThreatsData.forEach((threat, index) => {
          threatLookup[index] = threat; // Use index 0, 1, 2... as the key
      });
      // console.log("Threat data loaded into threatLookup:", threatLookup); // For debugging
    </script>
  </head>
  <body>
    <div class="container mt-4">
      <header
        class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom"
      >
        <h1 class="h2"><i class="bi bi-check2-circle me-2"></i>Scan Results</h1>
        <div>
          {# Wrap buttons/links #}
          <a
            href="{{ url_for('quarantine_view') }}"
            class="btn btn-sm btn-outline-secondary me-2"
            ><i class="bi bi-shield-lock-fill me-1"></i>View Quarantine</a
          >
          <a
            href="{{ url_for('index') }}"
            class="btn btn-sm btn-outline-secondary"
            ><i class="bi bi-arrow-clockwise me-1"></i>New Scan</a
          >
        </div>
      </header>

      {% with messages = get_flashed_messages(with_categories=true) %} {% if
      messages %} {% for category, message in messages %}
      <div
        class="alert alert-{{ category if category != 'error' else 'danger' }} alert-dismissible fade show shadow-sm"
        role="alert"
      >
        {{ message }}
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
      {% endfor %} {% endif %} {% endwith %} {% if detected_threats %}
      <div class="card shadow-sm">
        <div class="card-header bg-warning">
          <i class="bi bi-exclamation-diamond-fill me-2"></i> Potential Threats
          Detected ({{ detected_threats|length }})
        </div>
        <div class="card-body">
          <p class="card-text">
            Select files below to move them to the quarantine directory.
          </p>
          <form action="{{ url_for('perform_quarantine') }}" method="post">
            <div class="table-responsive">
              <table
                class="table table-striped table-hover table-bordered table-sm"
              >
                <thead>
                  <tr>
                    <th scope="col" class="text-center" style="width: 5%">
                      <input
                        class="form-check-input"
                        type="checkbox"
                        id="select-all"
                        title="Select/Deselect All"
                      />
                    </th>
                    <th scope="col" style="width: 50%">File Path / ID</th>
                    <th scope="col" style="width: 20%">Detection Reason</th>
                    <th scope="col" style="width: 25%">Details</th>
                  </tr>
                </thead>
                <tbody>
                  {% for threat in detected_threats %}
                  <tr>
                    <td class="text-center">
                      <input
                        class="form-check-input action-checkbox"
                        type="checkbox"
                        id="file_{{ loop.index }}"
                        value="{{ loop.index0 }}"
                      />
                      {# Store the list index (0-based) #}
                    </td>
                    <td>
                      <label
                        for="file_{{ loop.index }}"
                        class="form-check-label ms-1"
                        ><code>{{ threat.path }}</code></label
                      >
                      {# Display path potentially including zip #}
                    </td>
                    <td>
                      <span
                        class="badge fs-base {% if threat.reason == 'YARA Rule' %} bg-danger text-white {% elif threat.reason.startswith('Known Hash') %} bg-warning text-dark {% elif threat.reason == 'Suspicious Name' %} bg-info text-dark {% else %} bg-secondary {% endif %}"
                        ><i
                          class="bi {% if threat.reason == 'YARA Rule' %} bi-bug-fill {% elif threat.reason.startswith('Known Hash') %} bi-hash {% elif threat.reason == 'Suspicious Name' %} bi-file-earmark-medical-fill {% else %} bi-question-circle {% endif %} me-1"
                        ></i
                        >{{ threat.reason }}</span
                      >
                    </td>
                    <td>{{ threat.details }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            <div id="hidden-details-container" style="display: none"></div>
            <button type="submit" class="btn btn-warning mt-3 shadow-sm">
              <i class="bi bi-shield-lock-fill me-2"></i>Quarantine Selected
              Files
            </button>
          </form>
        </div>
      </div>
      {% else %}
      <div
        class="alert alert-success shadow-sm d-flex align-items-center"
        role="alert"
      >
        <i class="bi bi-check-circle-fill me-3 fs-4"></i>
        <div>
          <h4 class="alert-heading">All Clear!</h4>
          <p class="mb-0">
            No threats were detected in the scanned directory based on the
            current configuration.
          </p>
        </div>
      </div>
      {% endif %}

      <footer class="footer text-muted border-top">
        &copy; {{ current_year }} - Malware Detection Demo (Riverside, CA)
      </footer>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
      crossorigin="anonymous"
    ></script>

    <script>
      // Select/deselect all checkbox functionality
      document.getElementById('select-all')?.addEventListener('click', function(event) {
          const checkboxes = document.querySelectorAll('.action-checkbox');
          checkboxes.forEach(checkbox => {
              checkbox.checked = event.target.checked;
          });
      });

      // UPDATED: Use checkbox value (index) to lookup data from JS variable
      const quarantineForm = document.querySelector('form[action="{{ url_for('perform_quarantine') }}"]');
      const hiddenContainer = document.getElementById('hidden-details-container');

      quarantineForm?.addEventListener('submit', function(event) {
          // Ensure container exists
          if (!hiddenContainer) {
              console.error("Fatal: Cannot find hidden-details-container element.");
              event.preventDefault(); // Stop submission
              alert("An internal error occurred (Cannot find hidden container). Please reload.");
              return;
          }
          hiddenContainer.innerHTML = ''; // Clear previous hidden inputs

          const selectedItems = []; // Array to hold the full detail objects
          const checkboxes = document.querySelectorAll('.action-checkbox:checked');

          checkboxes.forEach(checkbox => {
              const itemIndex = parseInt(checkbox.value, 10); // Get the index from checkbox value

              // Lookup the threat data using the index from the pre-loaded data
              // Use the threatLookup map created earlier
              if (typeof threatLookup !== 'undefined' && threatLookup.hasOwnProperty(itemIndex)) {
                   const threatData = threatLookup[itemIndex];
                   selectedItems.push(threatData); // Add the full object
              } else {
                  console.warn(`Could not find threat data for index: ${itemIndex}. ThreatLookup object might be missing or index is invalid.`);
              }
          });

          if (selectedItems.length > 0) {
              // Create ONE hidden input containing the JSON string of the entire array
              try {
                  const hiddenInput = document.createElement('input');
                  hiddenInput.type = 'hidden';
                  hiddenInput.name = 'selected_items_json'; // Name expected by backend
                  hiddenInput.value = JSON.stringify(selectedItems); // Convert array of objects back to JSON string
                  hiddenContainer.appendChild(hiddenInput);
                  console.log(`Form submit: Added 1 hidden input 'selected_items_json' with ${selectedItems.length} items.`);
              } catch(e) {
                   console.error("Error creating or appending hidden input:", e);
                   event.preventDefault(); // Stop submission on error
                   alert("An internal error occurred while preparing data for submission.");
                   return;
              }
          } else if (checkboxes.length > 0){
               console.error("Form submit: Checkboxes checked, but failed to gather valid item data using index lookup.");
               // Optionally prevent submission if data wasn't found?
               // event.preventDefault();
               // alert("Error processing selection. Data lookup failed.");
          } else {
              console.log("Form submit: No items selected or no hidden input needed.");
              // If no items selected, perhaps provide feedback instead of submitting empty?
              // alert("Please select at least one item to quarantine.");
              // event.preventDefault(); // Prevent submission if nothing selected
          }
          // Allow form submission to proceed (unless preventDefault was called)
      });
    </script>
  </body>
</html>
